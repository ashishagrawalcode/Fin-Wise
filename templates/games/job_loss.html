<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Loss Crisis | RupeeVerse</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=25">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Specific Styles for Scenario Game */
        .game-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 10px;
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: #E2E8F0;
            border-radius: 4px;
            margin-bottom: 40px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366F1, #8B5CF6);
            width: 0%;
            transition: width 0.5s ease;
        }

        .scenario-card {
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.05);
            animation: fadeIn 0.5s;
        }

        .emoji-icon { font-size: 3rem; margin-bottom: 20px; display: block; }

        .situation-box {
            background: #FFFBEB;
            border: 1px solid #FEF3C7;
            color: #92400E;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0 30px 0;
            font-size: 0.95rem;
        }

        .choice-btn {
            display: block;
            width: 100%;
            text-align: left;
            background: white;
            border: 1px solid #E2E8F0;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }

        .choice-btn:hover {
            border-color: var(--primary);
            background: #F8FAFC;
            transform: translateY(-2px);
        }

        .choice-btn.selected {
            border-color: var(--primary);
            background: #EFF6FF;
            pointer-events: none;
        }

        .feedback-box {
            display: none; /* Hidden initially */
            background: #DCFCE7;
            border: 1px solid #BBF7D0;
            color: #166534;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            animation: slideUp 0.3s;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body style="background-color: #F8FAFC;">

    <header style="background: white; height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 5%; border-bottom: 1px solid #E2E8F0;">
        <div class="logo-container">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="RupeeVerse" style="height: 40px;">
            RupeeVerse
        </div>
        <button onclick="location.href='/simulations'" class="btn-outline" style="border:none;">Exit Simulation</button>
    </header>

    <div class="game-container" id="introScreen">
        <div class="scenario-card" style="text-align: center;">
            <div class="emoji-icon">üò®</div>
            <h1 style="margin-bottom: 15px; font-size: 2.5rem;">Job Loss Crisis</h1>
            <p style="color: var(--text-muted); font-size: 1.1rem; margin-bottom: 30px;">
                Suddenly laid off without warning. You have 6 months of expenses saved. Can you survive financially without ruining your future?
            </p>
            
            <div style="background: #EFF6FF; padding: 20px; border-radius: 12px; text-align: left; margin-bottom: 30px;">
                <strong><i class="fa-solid fa-bullseye"></i> Goal:</strong> Maintain a high Financial Health Score.<br><br>
                <strong><i class="fa-regular fa-clock"></i> Timeframe:</strong> 6 Months Simulation
            </div>

            <button class="btn-primary" onclick="startGame()" style="font-size: 1.2rem; padding: 15px 40px;">Begin Scenario</button>
        </div>
    </div>

    <div class="game-container" id="gameScreen" style="display: none;">
        
        <div class="top-bar">
            <div>
                <div style="color: var(--text-muted); font-size: 0.9rem;" id="monthLabel">Month 1</div>
                <h2 id="scenarioTitle">The Shock</h2>
            </div>
            <div style="text-align: right;">
                <div style="color: var(--text-muted); font-size: 0.8rem;">Score</div>
                <div style="font-size: 2rem; font-weight: 800; color: var(--primary);" id="scoreValue">100</div>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-bar-fill" id="progressBar"></div>
        </div>

        <div class="scenario-card">
            <div class="emoji-icon" id="scenarioEmoji">üò∞</div>
            <h3 id="scenarioQuestion">You just lost your job. Your monthly expenses are ‚Çπ50,000.</h3>
            
            <div class="situation-box">
                <i class="fa-solid fa-circle-info"></i> 
                <span id="situationText">Situation: You have ‚Çπ3,00,000 in savings, ‚Çπ1,50,000 in investments, no severance.</span>
            </div>

            <div id="choicesContainer">
                </div>

            <div class="feedback-box" id="feedbackBox">
                <div style="display: flex; gap: 15px;">
                    <i class="fa-solid fa-check-circle" style="font-size: 1.5rem; margin-top: 3px;"></i>
                    <div>
                        <strong id="feedbackTitle">Excellent Choice!</strong>
                        <p id="feedbackText" style="margin: 5px 0 10px 0; color: #14532D;">You protected your salary and got back to work quickly.</p>
                        <div style="font-weight: 700; color: #16A34A;" id="scoreImpact">+10 Score</div>
                    </div>
                </div>
                <button class="btn-primary" onclick="nextScenario()" style="margin-top: 20px; width: 100%;">Next Month <i class="fa-solid fa-arrow-right"></i></button>
            </div>

        </div>
    </div>

    <div class="game-container" id="resultScreen" style="display: none;">
        <div class="scenario-card" style="text-align: center; background: linear-gradient(to bottom, #EFF6FF, #FFFFFF);">
            <div style="font-size: 4rem; margin-bottom: 20px;">üèÜ</div>
            <h1 style="color: var(--primary); margin-bottom: 10px;">Simulation Complete</h1>
            <p style="color: var(--text-muted); font-size: 1.2rem;">Final Score: <span id="finalScore" style="font-weight: 800; color: #0F172A;">195</span>/200</p>
            
            <div style="background: white; border: 1px solid #E2E8F0; border-radius: 12px; padding: 30px; margin: 30px 0; text-align: left;">
                <h3 style="margin-bottom: 15px; color: var(--primary);">Key Lessons</h3>
                <ul style="list-style: none; padding: 0;">
                    <li style="margin-bottom: 15px; display: flex; gap: 10px;">
                        <i class="fa-solid fa-check" style="color: #16A34A; margin-top: 4px;"></i> 
                        Emergency funds are essential - you navigated the crisis well!
                    </li>
                    <li style="margin-bottom: 15px; display: flex; gap: 10px;">
                        <i class="fa-solid fa-check" style="color: #16A34A; margin-top: 4px;"></i> 
                        Honest communication with creditors works better than avoidance.
                    </li>
                    <li style="margin-bottom: 15px; display: flex; gap: 10px;">
                        <i class="fa-solid fa-check" style="color: #16A34A; margin-top: 4px;"></i> 
                        Getting back to work quickly beats holding out for the "perfect" role.
                    </li>
                </ul>
            </div>

            <button class="btn-primary" onclick="location.href='/simulations'" style="width: 100%;">Back to Simulations</button>
        </div>
    </div>

    <script>
        // SCENARIO DATA
        const scenarios = [
            {
                month: "Month 1",
                title: "The Shock",
                emoji: "üò∞",
                question: "You just lost your job. Your monthly expenses are ‚Çπ50,000.",
                situation: "You have ‚Çπ3,00,000 in savings, ‚Çπ1,50,000 in investments, no severance.",
                choices: [
                    {
                        text: "Immediately start aggressively job searching (networking, courses)",
                        subtext: "Cost: ‚Çπ5,000 on courses, but higher job prospects.",
                        feedback: "Smart move. Acting fast minimizes the gap in your resume.",
                        scoreChange: 20,
                        type: "good"
                    },
                    {
                        text: "Take a week off to relax and recover emotionally",
                        subtext: "Good for mental health, but lose 1 week of search time.",
                        feedback: "Understandable, but in a crisis, time is money. You lost valuable lead time.",
                        scoreChange: -10,
                        type: "bad"
                    },
                    {
                        text: "Panic and liquidate your investments immediately",
                        subtext: "Lose ‚Çπ30,000 in penalties/taxes, but have cash.",
                        feedback: "Bad choice! You destroyed long-term wealth when you had enough cash savings.",
                        scoreChange: -50,
                        type: "bad"
                    }
                ]
            },
            {
                month: "Month 3",
                title: "The Squeeze",
                emoji: "üìâ",
                question: "Savings are draining. You have 2 months of runway left.",
                situation: "You haven't found a job yet. A big insurance payment of ‚Çπ15,000 is due.",
                choices: [
                    {
                        text: "Cut all non-essential expenses (Netflix, Eating Out, Gym)",
                        subtext: "Save ‚Çπ8,000/month immediately.",
                        feedback: "Excellent discipline. Extending your runway is the priority.",
                        scoreChange: 30,
                        type: "good"
                    },
                    {
                        text: "Pay the insurance using Credit Card",
                        subtext: "Keep cash, but add high-interest debt.",
                        feedback: "Risky. High-interest debt spirals quickly when you have no income.",
                        scoreChange: -20,
                        type: "bad"
                    },
                    {
                        text: "Ignore the insurance payment",
                        subtext: "Risk lapsing coverage.",
                        feedback: "Very dangerous. One medical emergency could bankrupt you now.",
                        scoreChange: -40,
                        type: "bad"
                    }
                ]
            },
            {
                month: "Month 4",
                title: "Turning Point",
                emoji: "ü§î",
                question: "You have 2 job offers.",
                situation: "Offer A: 30% lower salary, start now. Offer B: Same salary, but in a different city (moving costs).",
                choices: [
                    {
                        text: "Accept Offer A (Lower Salary)",
                        subtext: "Immediate income, stop the bleeding.",
                        feedback: "Prudent. Getting cash flow positive is more important than ego right now.",
                        scoreChange: 40,
                        type: "good"
                    },
                    {
                        text: "Accept Offer B (Move City)",
                        subtext: "Higher salary, but ‚Çπ50k moving cost.",
                        feedback: "Risky. The moving cost wipes out your remaining safety net.",
                        scoreChange: 0,
                        type: "neutral"
                    },
                    {
                        text: "Reject both, wait for better",
                        subtext: "Risk another month of unemployment.",
                        feedback: "Gamble failed. You have no savings left to wait longer.",
                        scoreChange: -30,
                        type: "bad"
                    }
                ]
            }
        ];

        let currentStep = 0;
        let score = 100;

        function startGame() {
            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            loadScenario();
        }

        function loadScenario() {
            const data = scenarios[currentStep];
            
            // Update UI
            document.getElementById('monthLabel').innerText = data.month;
            document.getElementById('scenarioTitle').innerText = data.title;
            document.getElementById('scoreValue').innerText = score;
            document.getElementById('progressBar').style.width = `${((currentStep)/scenarios.length)*100}%`;
            
            document.getElementById('scenarioEmoji').innerText = data.emoji;
            document.getElementById('scenarioQuestion').innerText = data.question;
            document.getElementById('situationText').innerText = "Situation: " + data.situation;
            
            // Reset Feedback
            document.getElementById('feedbackBox').style.display = 'none';

            // Generate Buttons
            const container = document.getElementById('choicesContainer');
            container.innerHTML = '';
            
            data.choices.forEach((choice, index) => {
                const btn = document.createElement('div');
                btn.className = 'choice-btn';
                btn.innerHTML = `
                    <div style="display:flex; gap:15px; align-items:center;">
                        <div style="background:#F1F5F9; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:var(--text-muted);">${String.fromCharCode(65+index)}</div>
                        <div>
                            <div style="font-weight:600; font-size:1rem; color:var(--text-main);">${choice.text}</div>
                            <div style="font-size:0.85rem; color:var(--text-muted); margin-top:5px;">${choice.subtext}</div>
                        </div>
                    </div>
                `;
                btn.onclick = () => makeChoice(index, btn);
                container.appendChild(btn);
            });
        }

        function makeChoice(index, btnElement) {
            // Disable all buttons
            const allBtns = document.querySelectorAll('.choice-btn');
            allBtns.forEach(b => b.style.pointerEvents = 'none');
            btnElement.classList.add('selected');

            const data = scenarios[currentStep].choices[index];
            
            // Update Score
            score += data.scoreChange;
            document.getElementById('scoreValue').innerText = score;
            
            // Show Feedback
            const fbBox = document.getElementById('feedbackBox');
            const fbTitle = document.getElementById('feedbackTitle');
            const fbText = document.getElementById('feedbackText');
            const fbScore = document.getElementById('scoreImpact');

            fbText.innerText = data.feedback;
            fbScore.innerText = (data.scoreChange > 0 ? '+' : '') + data.scoreChange + " Score";

            if (data.type === 'good') {
                fbBox.style.background = '#DCFCE7';
                fbBox.style.borderColor = '#BBF7D0';
                fbTitle.innerText = "Excellent Choice!";
                fbTitle.style.color = '#166534';
            } else {
                fbBox.style.background = '#FEE2E2';
                fbBox.style.borderColor = '#FECACA';
                fbTitle.innerText = "Risky Decision";
                fbTitle.style.color = '#991B1B';
                fbScore.style.color = '#DC2626';
            }
            
            fbBox.style.display = 'block';
        }

        function nextScenario() {
            currentStep++;
            if (currentStep < scenarios.length) {
                loadScenario();
            } else {
                showResults();
            }
        }

        async function showResults() {
            // Show the result screen
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'block';
            document.getElementById('finalScore').innerText = score;

            // Calculate XP based on score (Score * 2)
            const xpEarned = score * 2;

            // Call Backend API
            await fetch('/api/earn-xp', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ amount: xpEarned })
            });

            // You can optionally update a UI element here to show "+XP"
            console.log("XP Awarded: " + xpEarned);
        }
    </script>
</body>
</html>